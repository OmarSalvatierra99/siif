{% extends "base.html" %}

{% block title %}Reporte General{% endblock %}

{% block header_title %}SIPAC - Reporte General{% endblock %}

{% block nav_links %}
<a href="/" style="color: white; margin-right: 1rem;">Inicio</a>
<a href="/dashboard" style="color: white; margin-right: 1rem;">Dashboard</a>
<a href="/reportes" style="color: white;">Reportes Descargables</a>
{% endblock %}

{% block extra_css %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.reporte-container {
    padding: 1.5rem;
    max-width: 100%;
    background: #f8f9fa;
    min-height: 100vh;
}

.header-reporte {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    text-align: center;
}

.header-reporte img {
    max-width: 120px;
    height: auto;
    margin-bottom: 0.5rem;
}

.header-reporte h1 {
    font-size: 1.5rem;
    color: #2c5282;
    margin-bottom: 0.3rem;
}

.header-reporte p {
    font-size: 0.9rem;
    color: #718096;
}

.info-bar {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.info-stats {
    display: flex;
    gap: 2rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 0.75rem;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2c5282;
}

.btn-exportar {
    background: #38a169;
    color: white;
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.btn-exportar:hover {
    background: #2f855a;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.tabla-wrapper {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.tabla-reporte {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

.tabla-reporte thead {
    background: linear-gradient(135deg, #2c5282 0%, #2b6cb0 100%);
}

.tabla-reporte th {
    color: white;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
    white-space: nowrap;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.3px;
    border-right: 1px solid rgba(255,255,255,0.1);
    z-index: 10;
}

.tabla-reporte th:last-child {
    border-right: none;
}

.tabla-reporte tbody tr {
    transition: background 0.15s;
}

.tabla-reporte tbody tr:nth-child(even) {
    background: #f8f9fa;
}

.tabla-reporte tbody tr:hover {
    background: #e6f3ff;
}

.tabla-reporte td {
    padding: 8px;
    border-bottom: 1px solid #e2e8f0;
    white-space: nowrap;
}

.money {
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: 500;
}

.positive {
    color: #38a169;
}

.negative {
    color: #e53e3e;
}

.loading-container {
    text-align: center;
    padding: 4rem 2rem;
}

.spinner {
    border: 4px solid #f3f4f6;
    border-top: 4px solid #2c5282;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.tabla-scroll-wrapper {
    max-height: calc(100vh - 320px);
    overflow-y: auto;
    overflow-x: auto;
}

/* Scrollbar personalizado */
.tabla-scroll-wrapper::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

.tabla-scroll-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.tabla-scroll-wrapper::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 5px;
}

.tabla-scroll-wrapper::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}
</style>
{% endblock %}

{% block content %}
<main class="reporte-container">
    <!-- Header con logo -->
    <div class="header-reporte">
        <img src="/static/img/ofs_logo.png" alt="Logo OFS">
        <h1>Reporte General de Transacciones</h1>
        <p>Sistema de Procesamiento de Auxiliares Contables</p>
    </div>

    <!-- Barra de informaci칩n y exportar -->
    <div class="info-bar">
        <div class="info-stats">
            <div class="stat-item">
                <span class="stat-label">Total Registros</span>
                <span class="stat-value" id="totalRegistros">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Cargos Totales</span>
                <span class="stat-value money positive" id="totalCargos">$0.00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Abonos Totales</span>
                <span class="stat-value money negative" id="totalAbonos">$0.00</span>
            </div>
        </div>
        <button onclick="exportarExcel()" class="btn-exportar">游닌 Exportar a Excel</button>
    </div>

    <!-- Tabla de resultados -->
    <div class="tabla-wrapper">
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <p>Cargando transacciones...</p>
        </div>
        <div class="tabla-scroll-wrapper" id="tablaScrollWrapper" style="display: none;">
            <table class="tabla-reporte" id="tablaReporte">
                <thead>
                    <tr>
                        <th>Cuenta Contable</th>
                        <th>Genero</th>
                        <th>Grupo</th>
                        <th>Rubro</th>
                        <th>Cuenta</th>
                        <th>Subcuenta</th>
                        <th>Dependencia</th>
                        <th>Unidad Resp.</th>
                        <th>Centro Costo</th>
                        <th>Proyecto Pres.</th>
                        <th>Fuente</th>
                        <th>SubFuente</th>
                        <th>Tipo Recurso</th>
                        <th>Partida Pres.</th>
                        <th>Nombre Cuenta</th>
                        <th>Fecha</th>
                        <th>P칩liza</th>
                        <th>Beneficiario</th>
                        <th>Descripci칩n</th>
                        <th>O.P.</th>
                        <th>Saldo Inicial</th>
                        <th>Cargos</th>
                        <th>Abonos</th>
                        <th>Saldo Final</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                </tbody>
            </table>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
let transaccionesActuales = [];
let paginaActual = 1;
const registrosPorPagina = 5000;

// Cargar todas las transacciones
async function cargarTransacciones() {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('tablaScrollWrapper').style.display = 'none';

        const params = new URLSearchParams({
            page: paginaActual,
            per_page: registrosPorPagina
        });

        const response = await fetch(`/api/transacciones?${params}`);
        const data = await response.json();

        transaccionesActuales = data.transacciones;

        const tbody = document.getElementById('tablaBody');
        tbody.innerHTML = '';

        let totalCargos = 0;
        let totalAbonos = 0;

        data.transacciones.forEach(t => {
            totalCargos += parseFloat(t.cargos || 0);
            totalAbonos += parseFloat(t.abonos || 0);

            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${t.cuenta_contable || ''}</strong></td>
                <td>${t.genero || ''}</td>
                <td>${t.grupo || ''}</td>
                <td>${t.rubro || ''}</td>
                <td>${t.cuenta || ''}</td>
                <td>${t.subcuenta || ''}</td>
                <td>${t.dependencia || ''}</td>
                <td>${t.unidad_responsable || ''}</td>
                <td>${t.centro_costo || ''}</td>
                <td>${t.proyecto_presupuestario || ''}</td>
                <td>${t.fuente || ''}</td>
                <td>${t.subfuente || ''}</td>
                <td>${t.tipo_recurso || ''}</td>
                <td>${t.partida_presupuestal || ''}</td>
                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.nombre_cuenta || ''}">${t.nombre_cuenta || ''}</td>
                <td>${formatDate(t.fecha_transaccion)}</td>
                <td>${t.poliza || ''}</td>
                <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.beneficiario || ''}">${t.beneficiario || ''}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.descripcion || ''}">${t.descripcion || ''}</td>
                <td>${t.orden_pago || ''}</td>
                <td class="money">${formatNumber(t.saldo_inicial)}</td>
                <td class="money positive">${formatNumber(t.cargos)}</td>
                <td class="money negative">${formatNumber(t.abonos)}</td>
                <td class="money"><strong>${formatNumber(t.saldo_final)}</strong></td>
            `;
        });

        // Actualizar estad칤sticas
        document.getElementById('totalRegistros').textContent = data.total.toLocaleString('es-MX');
        document.getElementById('totalCargos').textContent = formatCurrency(totalCargos);
        document.getElementById('totalAbonos').textContent = formatCurrency(totalAbonos);

        document.getElementById('loading').style.display = 'none';
        document.getElementById('tablaScrollWrapper').style.display = 'block';

    } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = '<p style="color: #e53e3e;">Error al cargar datos. Por favor, recargue la p치gina.</p>';
    }
}

// Exportar a Excel
async function exportarExcel() {
    if (!transaccionesActuales.length) {
        alert('No hay datos para exportar.');
        return;
    }

    try {
        const response = await fetch('/api/reportes/generar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });

        if (!response.ok) throw new Error('Error al generar reporte');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_general_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert('Error al exportar: ' + error.message);
    }
}

function formatNumber(num) {
    return (num || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatCurrency(num) {
    return '$' + (num || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('es-MX');
}

// Cargar al inicio
window.addEventListener('DOMContentLoaded', () => {
    cargarTransacciones();
});
</script>
{% endblock %}
