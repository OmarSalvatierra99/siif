{% extends "base.html" %}

{% block title %}Consultar Transacciones - SIPAC{% endblock %}

{% block extra_css %}
<style>
    .consulta-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
    }

    .header-flex {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--color-primary);
    }

    .header-flex h2 {
        color: var(--color-primary);
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }

    .header-flex .subtitle {
        color: var(--color-muted);
        font-size: 0.95rem;
    }

    .filters-section {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--color-primary);
    }

    .filter-group input,
    .filter-group select {
        padding: 0.6rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .filter-actions {
        display: flex;
        gap: 0.8rem;
        margin-top: 1rem;
        justify-content: flex-end;
    }

    .stats-bar {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border-radius: var(--radius);
        border: 1px solid #bfdbfe;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--color-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-primary);
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination button {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--color-border);
        background: var(--color-surface);
        border-radius: 4px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
    }

    .pagination button:hover:not(:disabled) {
        background: var(--color-bg);
        border-color: var(--color-primary);
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .table-wrapper {
        background: var(--color-surface);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .table-scroll {
        overflow-x: auto;
        max-height: calc(100vh - 500px);
    }

    .tabla-resultados {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem;
    }

    .tabla-resultados th {
        position: sticky;
        top: 0;
        background: var(--color-primary);
        color: #fff;
        padding: 0.7rem 0.5rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        white-space: nowrap;
        z-index: 10;
    }

    .tabla-resultados td {
        border-bottom: 1px solid var(--color-border);
        padding: 0.6rem 0.5rem;
        font-size: 0.75rem;
    }

    .tabla-resultados tr:nth-child(even) td {
        background: #f9fafc;
    }

    .tabla-resultados tr:hover td {
        background: #f3f4f6;
    }

    .money {
        text-align: right;
        font-family: 'Courier New', monospace;
        font-weight: 500;
    }

    .positive {
        color: #059669;
    }

    .negative {
        color: #dc2626;
    }

    .loading {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--color-muted);
    }

    .no-results {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--color-muted);
    }

    .msg-vacio {
        text-align: center;
        color: var(--color-muted);
        margin-top: 2rem;
        font-size: 0.95rem;
    }

    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
        .filter-actions {
            flex-direction: column;
            width: 100%;
        }
        .filter-actions button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="consulta-container">
    <div class="header-flex">
        <h2>Consultar Transacciones</h2>
        <span class="subtitle">B√∫squeda y visualizaci√≥n de transacciones contables</span>
    </div>

    <div class="filters-section">
        <h3 style="margin-bottom: 1rem; color: var(--color-primary);">Filtros de B√∫squeda</h3>
        <div class="filters-grid">
            <div class="filter-group">
                <label>Cuenta Contable</label>
                <input type="text" id="filtroCuenta" placeholder="Ej: 32210080500000000600N">
            </div>
            <div class="filter-group">
                <label>G√©nero</label>
                <input type="text" id="filtroGenero" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>Grupo</label>
                <input type="text" id="filtroGrupo" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>Rubro</label>
                <input type="text" id="filtroRubro" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>Cuenta</label>
                <input type="text" id="filtroCuentaNum" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Subcuenta</label>
                <input type="text" id="filtroSubcuenta" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Dependencia</label>
                <input type="text" id="filtroDependencia" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Unidad Responsable</label>
                <input type="text" id="filtroUnidadResponsable" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Centro de Costo</label>
                <input type="text" id="filtroCentroCosto" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Proyecto Presupuestario</label>
                <input type="text" id="filtroProyectoPresupuestario" placeholder="2 caracteres" maxlength="2">
            </div>
            <div class="filter-group">
                <label>Fuente</label>
                <input type="text" id="filtroFuente" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>SubFuente</label>
                <input type="text" id="filtroSubfuente" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>Tipo de Recurso</label>
                <input type="text" id="filtroTipoRecurso" placeholder="1 car√°cter" maxlength="1">
            </div>
            <div class="filter-group">
                <label>Partida Presupuestal</label>
                <input type="text" id="filtroPartidaPresupuestal" placeholder="4 caracteres" maxlength="4">
            </div>
            <div class="filter-group">
                <label>Nombre de Cuenta</label>
                <input type="text" id="filtroNombreCuenta" placeholder="Buscar por nombre">
            </div>
            <div class="filter-group">
                <label>Beneficiario</label>
                <input type="text" id="filtroBeneficiario" placeholder="Buscar beneficiario">
            </div>
            <div class="filter-group">
                <label>Descripci√≥n</label>
                <input type="text" id="filtroDescripcion" placeholder="Buscar descripci√≥n">
            </div>
            <div class="filter-group">
                <label>O.P.</label>
                <input type="text" id="filtroOrdenPago" placeholder="Orden de pago">
            </div>
            <div class="filter-group">
                <label>P√≥liza</label>
                <input type="text" id="filtroPoliza" placeholder="Buscar p√≥liza">
            </div>
            <div class="filter-group">
                <label>Fecha Inicio</label>
                <input type="date" id="filtroFechaInicio">
            </div>
            <div class="filter-group">
                <label>Fecha Fin</label>
                <input type="date" id="filtroFechaFin">
            </div>
        </div>
        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
            <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Total Registros</span>
            <span class="stat-value" id="totalRegistros">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cargos Totales</span>
            <span class="stat-value money positive" id="totalCargos">$0.00</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Abonos Totales</span>
            <span class="stat-value money negative" id="totalAbonos">$0.00</span>
        </div>
    </div>

    <div class="actions-bar">
        <div class="pagination">
            <button id="btnPrevPage" onclick="cambiarPagina(-1)">‚Äπ Anterior</button>
            <span id="paginaInfo">P√°gina 1</span>
            <button id="btnNextPage" onclick="cambiarPagina(1)">Siguiente ‚Ä∫</button>
        </div>
        <button class="btn btn-success" onclick="exportarExcel()">
            üì• Exportar a Excel
        </button>
    </div>

    <div class="table-wrapper">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando transacciones...</p>
        </div>
        <div class="table-scroll" id="tableContainer" style="display: none;">
            <table class="tabla-resultados">
                <thead>
                    <tr>
                        <th>Cuenta Contable</th>
                        <th>G√©nero</th>
                        <th>Grupo</th>
                        <th>Rubro</th>
                        <th>Cuenta</th>
                        <th>Subcuenta</th>
                        <th>Dependencia</th>
                        <th>Unidad Responsable</th>
                        <th>Centro de Costo</th>
                        <th>Proyecto Presupuestario</th>
                        <th>Fuente</th>
                        <th>SubFuente</th>
                        <th>Tipo de Recurso</th>
                        <th>Partida Presupuestal</th>
                        <th>Nombre de la Cuenta</th>
                        <th>FECHA</th>
                        <th>POLIZA</th>
                        <th>BENEFICIARIO</th>
                        <th>DESCRIPCION</th>
                        <th>O.P.</th>
                        <th>SALDO INICIAL</th>
                        <th>CARGOS</th>
                        <th>ABONOS</th>
                        <th>SALDO FINAL</th>
                    </tr>
                </thead>
                <tbody id="tablaBody">
                </tbody>
            </table>
        </div>
        <div id="noResults" class="no-results" style="display: none;">
            <p class="msg-vacio">No se encontraron transacciones</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let paginaActual = 1;
const registrosPorPagina = 50;
let totalPaginas = 0;
let filtrosActuales = {};

async function cargarTransacciones() {
    try {
        const params = new URLSearchParams({
            page: paginaActual,
            per_page: registrosPorPagina,
            ...filtrosActuales
        });

        const response = await fetch(`/api/transacciones?${params}`);
        const data = await response.json();

        totalPaginas = data.pages || 1;
        renderizarTabla(data.transacciones);
        actualizarEstadisticas(data);
        actualizarPaginacion();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('tableContainer').style.display = 'block';
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = `
            <div class="no-results">
                <p class="msg-vacio">‚ö†Ô∏è Error al cargar transacciones</p>
            </div>
        `;
    }
}

function renderizarTabla(transacciones) {
    const tbody = document.getElementById('tablaBody');
    const noResults = document.getElementById('noResults');
    const tableContainer = document.getElementById('tableContainer');

    tbody.innerHTML = '';

    if (!transacciones || transacciones.length === 0) {
        tableContainer.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }

    tableContainer.style.display = 'block';
    noResults.style.display = 'none';

    const fragment = document.createDocumentFragment();

    transacciones.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${t.cuenta_contable || ''}</strong></td>
            <td>${t.genero || ''}</td>
            <td>${t.grupo || ''}</td>
            <td>${t.rubro || ''}</td>
            <td>${t.cuenta || ''}</td>
            <td>${t.subcuenta || ''}</td>
            <td>${t.dependencia || ''}</td>
            <td>${t.unidad_responsable || ''}</td>
            <td>${t.centro_costo || ''}</td>
            <td>${t.proyecto_presupuestario || ''}</td>
            <td>${t.fuente || ''}</td>
            <td>${t.subfuente || ''}</td>
            <td>${t.tipo_recurso || ''}</td>
            <td>${t.partida_presupuestal || ''}</td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;" title="${t.nombre_cuenta || ''}">${truncate(t.nombre_cuenta, 40)}</td>
            <td>${t.fecha_transaccion || ''}</td>
            <td>${t.poliza || ''}</td>
            <td style="max-width: 180px; overflow: hidden; text-overflow: ellipsis;" title="${t.beneficiario || ''}">${truncate(t.beneficiario, 25)}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${t.descripcion || ''}">${truncate(t.descripcion, 30)}</td>
            <td>${t.orden_pago || ''}</td>
            <td class="money">${formatNumber(t.saldo_inicial)}</td>
            <td class="money positive">${formatNumber(t.cargos)}</td>
            <td class="money negative">${formatNumber(t.abonos)}</td>
            <td class="money"><strong>${formatNumber(t.saldo_final)}</strong></td>
        `;
        fragment.appendChild(row);
    });

    tbody.appendChild(fragment);
}

function actualizarEstadisticas(data) {
    document.getElementById('totalRegistros').textContent = (data.total || 0).toLocaleString('es-MX');

    let totalCargos = 0;
    let totalAbonos = 0;

    if (data.transacciones) {
        data.transacciones.forEach(t => {
            totalCargos += parseFloat(t.cargos || 0);
            totalAbonos += parseFloat(t.abonos || 0);
        });
    }

    document.getElementById('totalCargos').textContent = formatCurrency(totalCargos);
    document.getElementById('totalAbonos').textContent = formatCurrency(totalAbonos);
}

function actualizarPaginacion() {
    document.getElementById('paginaInfo').textContent = `P√°gina ${paginaActual} de ${totalPaginas}`;
    document.getElementById('btnPrevPage').disabled = paginaActual === 1;
    document.getElementById('btnNextPage').disabled = paginaActual === totalPaginas;
}

function cambiarPagina(delta) {
    const nuevaPagina = paginaActual + delta;
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
        paginaActual = nuevaPagina;
        cargarTransacciones();
    }
}

function aplicarFiltros() {
    filtrosActuales = {};

    const cuenta = document.getElementById('filtroCuenta').value.trim();
    if (cuenta) filtrosActuales.cuenta_contable = cuenta;

    const genero = document.getElementById('filtroGenero').value.trim();
    if (genero) filtrosActuales.genero = genero;

    const grupo = document.getElementById('filtroGrupo').value.trim();
    if (grupo) filtrosActuales.grupo = grupo;

    const rubro = document.getElementById('filtroRubro').value.trim();
    if (rubro) filtrosActuales.rubro = rubro;

    const cuentaNum = document.getElementById('filtroCuentaNum').value.trim();
    if (cuentaNum) filtrosActuales.cuenta = cuentaNum;

    const subcuenta = document.getElementById('filtroSubcuenta').value.trim();
    if (subcuenta) filtrosActuales.subcuenta = subcuenta;

    const dependencia = document.getElementById('filtroDependencia').value.trim();
    if (dependencia) filtrosActuales.dependencia = dependencia;

    const unidadResponsable = document.getElementById('filtroUnidadResponsable').value.trim();
    if (unidadResponsable) filtrosActuales.unidad_responsable = unidadResponsable;

    const centroCosto = document.getElementById('filtroCentroCosto').value.trim();
    if (centroCosto) filtrosActuales.centro_costo = centroCosto;

    const proyectoPresupuestario = document.getElementById('filtroProyectoPresupuestario').value.trim();
    if (proyectoPresupuestario) filtrosActuales.proyecto_presupuestario = proyectoPresupuestario;

    const fuente = document.getElementById('filtroFuente').value.trim();
    if (fuente) filtrosActuales.fuente = fuente;

    const subfuente = document.getElementById('filtroSubfuente').value.trim();
    if (subfuente) filtrosActuales.subfuente = subfuente;

    const tipoRecurso = document.getElementById('filtroTipoRecurso').value.trim();
    if (tipoRecurso) filtrosActuales.tipo_recurso = tipoRecurso;

    const partidaPresupuestal = document.getElementById('filtroPartidaPresupuestal').value.trim();
    if (partidaPresupuestal) filtrosActuales.partida_presupuestal = partidaPresupuestal;

    const nombreCuenta = document.getElementById('filtroNombreCuenta').value.trim();
    if (nombreCuenta) filtrosActuales.nombre_cuenta = nombreCuenta;

    const beneficiario = document.getElementById('filtroBeneficiario').value.trim();
    if (beneficiario) filtrosActuales.beneficiario = beneficiario;

    const descripcion = document.getElementById('filtroDescripcion').value.trim();
    if (descripcion) filtrosActuales.descripcion = descripcion;

    const ordenPago = document.getElementById('filtroOrdenPago').value.trim();
    if (ordenPago) filtrosActuales.orden_pago = ordenPago;

    const poliza = document.getElementById('filtroPoliza').value.trim();
    if (poliza) filtrosActuales.poliza = poliza;

    const fechaInicio = document.getElementById('filtroFechaInicio').value;
    if (fechaInicio) filtrosActuales.fecha_inicio = fechaInicio;

    const fechaFin = document.getElementById('filtroFechaFin').value;
    if (fechaFin) filtrosActuales.fecha_fin = fechaFin;

    paginaActual = 1;
    cargarTransacciones();
}

function limpiarFiltros() {
    document.getElementById('filtroCuenta').value = '';
    document.getElementById('filtroGenero').value = '';
    document.getElementById('filtroGrupo').value = '';
    document.getElementById('filtroRubro').value = '';
    document.getElementById('filtroCuentaNum').value = '';
    document.getElementById('filtroSubcuenta').value = '';
    document.getElementById('filtroDependencia').value = '';
    document.getElementById('filtroUnidadResponsable').value = '';
    document.getElementById('filtroCentroCosto').value = '';
    document.getElementById('filtroProyectoPresupuestario').value = '';
    document.getElementById('filtroFuente').value = '';
    document.getElementById('filtroSubfuente').value = '';
    document.getElementById('filtroTipoRecurso').value = '';
    document.getElementById('filtroPartidaPresupuestal').value = '';
    document.getElementById('filtroNombreCuenta').value = '';
    document.getElementById('filtroBeneficiario').value = '';
    document.getElementById('filtroDescripcion').value = '';
    document.getElementById('filtroOrdenPago').value = '';
    document.getElementById('filtroPoliza').value = '';
    document.getElementById('filtroFechaInicio').value = '';
    document.getElementById('filtroFechaFin').value = '';

    filtrosActuales = {};
    paginaActual = 1;
    cargarTransacciones();
}

async function exportarExcel() {
    try {
        const response = await fetch('/api/reportes/generar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filtrosActuales)
        });

        if (!response.ok) throw new Error('Error al generar reporte');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `reporte_sipac_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert('Error al exportar: ' + error.message);
    }
}

function formatNumber(num) {
    return (num || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function formatCurrency(num) {
    return '$' + (num || 0).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function truncate(str, maxLen) {
    if (!str) return '';
    return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
}

// Cargar al inicio
window.addEventListener('DOMContentLoaded', cargarTransacciones);
</script>
{% endblock %}
